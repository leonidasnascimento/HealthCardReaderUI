<!doctype html>

<html lang="en">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Elegibilidade</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<link href="../resources/style/style.css" rel="stylesheet">
	<link rel="icon" href="../resources/ico/acc.png">
</head>

<body>
	<div id="mainDiv">
		<div id="infoDiv">
			<div id="imageDiv">
				<div id="camDiv">
					<div class="container">
						<div class="modal fade" id="myModal" role="dialog">
							<div class="modal-dialog">
								<div class="modal-content">
									<div class="modal-header">
										<button type="button" class="close" data-dismiss="modal" onclick="closeModal()">&times;</button>

									</div>
									<div class="modal-body">
										<div id="my_camera" style="display:block; margin-left:auto; margin-right:auto; width: 50%"></div>
										<div class="modal-footer">
											<button type=button class="btn btn-default" value="Take Snapshot" onClick="take_snapshot();showLoading()" data-dismiss="modal">Capturar</button>
											<button type="button" class="btn btn-default" data-dismiss="modal" onclick="closeModal()">Fechar</button>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div id="showImage">Sua imagem aparecerá aqui...</div>
				<div id="results" style="margin-left: 44%;margin-top: -2%;margin-bottom: -11%"></div>
				<img id="output" style="width: 50%; margin-top:4%; margin-left: 50%" />
			</div>
			<div id="resultDiv">
				<section class="cardInfos">
					<ul>
						<div class="list" class="inputCardInfos">
							<li>
								Nome:
							</li>
							<input type="text" name="" class="inputCardInfos" id="valueJsonName" size="35">
						</div>
						<div class="list">
							<li>
								Número do Cartão:
							</li>
							<input type="text" class="inputCardInfos" id="valueJsonCardNumber" size="35">
						</div>
						<div class="list">
							<li>
								Data de Validade:
							</li>
							<input type="text" class="inputCardInfos" id="valueJsonValidDate" size="35">
						</div>
						<div class="list">
							<li>
								Plano:
							</li>
							<input type="text" class="inputCardInfos" id="valueJsonHealthInsurance" size="35">
						</div>
						<div class="list">
							<li>
								Convênio:
							</li>
							<input type="text" class="inputCardInfos" id="valueJsonLogo" size="35">
						</div>
						<div class="list">
							<li>
								Empresa:
							</li>
							<input type="text" class="inputCardInfos" id="valueJsonCompany" size="35">
						</div>
						<div class="list">
							<li>
								Eligibilidades:
							</li>
							<input type="text" class="inputCardInfos" id="valueJsonEligibilities" size="35">
						</div>
					</ul>
				</section>
			</div>
		</div>
		<br>
		<br>
		<br>
		<div id="commandTools">
			<div id="loadImageDiv">
				<button id="takePic" data-toggle="modal" data-target="#myModal" onclick="takePicClick()">Câmera</button>
			</div>

			<div id="processImageDiv">
				<input type="file" id="imageFileInput" accept=".png, .jpg, .jpeg" onchange="loadFile(event)"/>
				<button id="processImage" onclick="showLoading()">Checar elegibilidade</button>
				<div id="loader" style="display:none">

				</div>
			</div>
		</div>
	</div>

	<!-- First, include the Webcam.js JavaScript Library -->
	<script type="text/javascript" src="../webcam.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<!-- Configure a few settings and attach camera -->
	<script language="JavaScript">
		function showLoading(){
			document.getElementById("loader").style.display = "block";
			// document.getElementsByTagName("body")[0].style.background = "rgba(0,0,0,.85)";
			// document.getElementsByTagName("body")[0].style.zIndex = "-1";
		}

		function hideLoading(){
			document.getElementById("loader").style.display = "none";
		}
		//Readiness events
		document.getElementById('processImage').addEventListener('click', function () {
			var files = document.getElementById('imageFileInput').files;
			if (files.length > 0) {
				getBase64(files[0]);
			}
		});

		function takePicClick() {

			Webcam.set({
				width: 320,
				height: 255,
				image_format: 'jpeg',
				jpeg_quality: 90
			});
			Webcam.attach('#my_camera');
		}

		function loadFile(event) {
			var output = document.getElementById('output');
			output.src = URL.createObjectURL(event.target.files[0]);
			document.getElementById('showImage').style.display = 'none';
			document.getElementById("output").style.display = "block"; 
			document.getElementById("results").style.display = "none"; 

		};

		function getBase64(file) {

			console.log("Método 'getBase64'");

			var reader = new FileReader();
			reader.readAsDataURL(file);
			reader.onload = function () {
				console.log(reader.result);
				postImage(reader.result);
			};
		}

		function readJson(response) {
			if (response === null || response === undefined) return;

			if (JSON.stringify(response["Name"]) === null || JSON.stringify(response["Name"]) === undefined)
				document.getElementById("valueJsonName").value = " ";
			else
				document.getElementById("valueJsonName").value = JSON.stringify(response["Name"]).replace("\"", "").replace(
					"\"", "");

			if (JSON.stringify(response["CardNumber"]) === null || JSON.stringify(response["CardNumber"]) === undefined)
				document.getElementById("valueJsonCardNumber").value = " ";
			else
				document.getElementById("valueJsonCardNumber").value = JSON.stringify(response["CardNumber"]).replace("\"",
					"").replace("\"",
					"");

			if (JSON.stringify(response["ExpirationDate"]) === null || JSON.stringify(response["ExpirationDate"]) ===
				undefined)
				document.getElementById("valueJsonValidDate").value = " ";
			else
				document.getElementById("valueJsonValidDate").value = parseDate(JSON.stringify(response["ExpirationDate"]).replace(
					"\"", "").replace("\"",
					"").replace("T00:00:00", ""));
				
			if (JSON.stringify(response["HealthInsurance"]) === null || JSON.stringify(response["HealthInsurance"]) ===
				undefined)
				document.getElementById("valueJsonHealthInsurance").value = " ";
			else
				document.getElementById("valueJsonHealthInsurance").value = JSON.stringify(response["HealthInsurance"]).replace(
					"\"", "").replace("\"",
					"");

			if (JSON.stringify(response["Logo"]) === null || JSON.stringify(response["Logo"]) === undefined)
				document.getElementById("valueJsonLogo").value = " ";
			else
				document.getElementById("valueJsonLogo").value = JSON.stringify(response["Logo"]).replace("\"", "").replace(
					"\"",
					"");

			if (JSON.stringify(response["Company"]) === null || JSON.stringify(response["Company"]) === undefined)
				document.getElementById("valueJsonCompany").value = " ";
			else
				document.getElementById("valueJsonCompany").value = JSON.stringify(response["Company"]).replace("\"", "").replace(
					"\"",
					"");
		}

		function postImage(image) {
			//Validations
			if (image === null || image === undefined) return;

			var imageAux = image.replace(/^data:image\/(png|jpeg|jpg);base64,/, "");

			console.log(imageAux);

			var settings = {
				"async": true,
				"crossDomain": true,
				"data": {
					'image': imageAux
				},
				"dataType": "json",
				"processData": true,
				//Azure service
				"url": "https://healthcardreader-api-accenture.azurewebsites.net/Home/ProcessarImagemAsync",
				//Local service 
				// "url": "http://localhost:56242/Home/ProcessarImagemAsync",
				"method": "POST"
			}

			//Log
			console.log(settings);

			$.ajax(settings)
				.done(function (response) {
					console.log(response);
					readJson(response);
				})
				.fail(function (jqXHR, textStatus, errorThrown) {
					alert(jqXHR.responseText);
	
					//Logs
					console.log("###### LOG DE ERRO ######");
					console.log(errorThrown);
					console.log(textStatus);
					console.log(jqXHR);
				})
				.always(function(){
					hideLoading();
				});
		}

		function parseDate(dateVal){
			var splitDate = dateVal.split('-');
			var year = splitDate[0];
			var month =splitDate[1];
			var day =splitDate[2];
			return day + "/" + month + "/" + year;
			return splitDate;
		}

		function closeModal() {
			location.reload(true);
		}

		function take_snapshot() {
			console.log("Método 'take_snapshot'");
			document.getElementById("results").style.display = "block"; 
			document.getElementById("output").style.display = "none"; 
			// take snapshot and get image data
			Webcam.snap(function (data_uri) {
				// display results in page
				document.getElementById('results').innerHTML =
					'<img src="' + data_uri + '"/>';
				document.getElementById('showImage').style.display = 'none';
				postImage(data_uri);
			})
		}
	</script>
</body>

</html>